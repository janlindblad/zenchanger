<!DOCTYPE html>
<html>
<head>
    <title>Secrets - ZenChanger</title>
    {% load static %}
    {% include "core/base_header.html" %}
    <style>
        .secret-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }
        .secret-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        .secret-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .secret-id {
            font-weight: bold;
            color: #666;
        }
        .ring-name {
            background: #e6f3ff;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }
        .secret-content {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            min-height: 40px;
            border: 1px solid #eee;
        }
        .encrypted {
            color: #999;
            font-style: italic;
        }
        .decrypted {
            color: #333;
        }
        .add-secret-section {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fff;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .btn {
            background: #2d662d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        .btn:hover {
            background: #228b22;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .nav-links {
            margin-bottom: 20px;
        }
        .nav-links a {
            background: #2d662d;
            color: #fff;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 4px;
            margin-right: 10px;
        }
        .nav-links a:hover {
            background: #228b22;
        }
        .messages {
            margin: 15px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #f5c6cb;
        }
        .no-access {
            background: #fff3cd;
            color: #856404;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="secret-container">
        <div class="nav-links">
            <a href="{% url 'home' %}">‚Üê Back to Home</a>
            <a href="{% url 'ring_view' %}">Manage Rings</a>
        </div>
        
        <h2>Secrets</h2>
        
        <!-- Display messages -->
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Add new secret section -->
        {% if user_rings %}
        <div class="add-secret-section">
            <h3>Add New Secret</h3>
            <form method="post" id="add-secret-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="ring_id">Ring:</label>
                    <select name="ring_id" id="ring_id" required>
                        <option value="">-- Select a ring --</option>
                        {% for ring in user_rings %}
                        <option value="{{ ring.id }}">{{ ring.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="secret_content">Secret Content:</label>
                    <textarea name="secret_content" id="secret_content" placeholder="Enter your secret here..." required></textarea>
                </div>
                <input type="hidden" name="encrypted_content" id="encrypted_content">
                <button type="button" class="btn" id="add-secret-btn">Add Secret</button>
            </form>
        </div>
        {% endif %}
        
        <!-- Secrets list -->
        <div id="secrets-list">
            {% if all_secrets %}
                {% for secret in all_secrets %}
                <div class="secret-card">
                    <div class="secret-header">
                        <span class="secret-id">Secret #{{ secret.id }}</span>
                        <span class="ring-name">{{ secret.ring.name }}</span>
                    </div>
                    <div class="secret-content" 
                         data-secret-id="{{ secret.id }}"
                         data-ring-id="{{ secret.ring.id }}"
                         data-encrypted-content="{{ secret.content }}">
                        {% if secret.ring.id in user_ring_keys %}
                            <span class="encrypted">Decrypting...</span>
                        {% else %}
                            <span class="no-access">No access to this ring</span>
                        {% endif %}
                    </div>
                    <small>Created: {{ secret.created_at|date:"M d, Y H:i" }}</small>
                </div>
                {% endfor %}
            {% else %}
                <div class="secret-card">
                    <p>No secrets found.</p>
                </div>
            {% endif %}
        </div>
        
        <button type="button" class="btn" onclick="testKeySetup()">Test Key Setup</button>
        <button type="button" class="btn" onclick="testKeyPair()">Test Key Pair</button>
    </div>

    {{ user_ring_keys|json_script:"user-ring-keys" }}

    <script type="module">
        import { encryptWithRingKey, decryptWithRingKey, decryptRingKey, validateKeySetup, testKeyPairCompatibility } from '{% static "ring/js/reckey.js" %}';
        
        // User's ring keys for decryption
        const userRingKeys = JSON.parse(document.getElementById('user-ring-keys').textContent);
        
        // Decrypt all accessible secrets on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const secretElements = document.querySelectorAll('.secret-content[data-encrypted-content]');
            
            for (const element of secretElements) {
                const ringId = element.getAttribute('data-ring-id');
                const encryptedContent = element.getAttribute('data-encrypted-content');
                
                if (userRingKeys[ringId]) {
                    try {
                        const decrypted = await decryptWithRingKey(encryptedContent, userRingKeys[ringId]);
                        element.innerHTML = `<span class="decrypted">${escapeHtml(decrypted)}</span>`;
                    } catch (error) {
                        console.error(`Error decrypting secret:`, error);
                        element.innerHTML = '<span class="encrypted">Failed to decrypt</span>';
                    }
                }
            }
        });
        
        // Handle adding new secret
        document.getElementById('add-secret-btn').addEventListener('click', async function() {
            const button = this;
            const form = document.getElementById('add-secret-form');
            const ringId = document.getElementById('ring_id').value;
            const secretContent = document.getElementById('secret_content').value;
            const encryptedContentField = document.getElementById('encrypted_content');
            
            if (!ringId || !secretContent.trim()) {
                alert('Please select a ring and enter secret content.');
                return;
            }
            
            try {
                button.disabled = true;
                button.textContent = 'Encrypting...';
                
                // Get the ring key
                const ringKey = userRingKeys[ringId];
                if (!ringKey) {
                    throw new Error('No ring key found for selected ring');
                }
                
                // Encrypt the content
                const encrypted = await encryptWithRingKey(secretContent, ringKey);
                encryptedContentField.value = encrypted;
                
                // Submit the form
                form.submit();
                
            } catch (error) {
                console.error('Error encrypting secret:', error);
                alert('Error encrypting secret. Please try again.');
                button.disabled = false;
                button.textContent = 'Add Secret';
            }
        });
        
        // Test key setup
        window.testKeySetup = async function() {
            await validateKeySetup();
        };
        
        // Test key pair compatibility
        window.testKeyPair = async function() {
            await testKeyPairCompatibility();
        };

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>